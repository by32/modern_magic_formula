name: Update Magic Formula Screening

on:
  schedule:
    # Run every Monday at 6:00 UTC (after markets close)
    - cron: '0 6 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-screening:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        pip install pandas requests yfinance fmp_python finnhub-python
        
    - name: Run ETL process
      env:
        ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
        FMP_KEY: ${{ secrets.FMP_KEY }}
        FINNHUB_KEY: ${{ secrets.FINNHUB_KEY }}
        IEX_TOKEN: ${{ secrets.IEX_TOKEN }}
      run: |
        # Try to run ETL with real API data, fallback to sample data if it fails
        if [ -z "$ALPHA_VANTAGE_KEY" ]; then
          echo "âš ï¸ No ALPHA_VANTAGE_KEY found. Generating sample data for demo..."
          python3 generate_sample_data.py
        else
          echo "ðŸ”‘ Running ETL with Alpha Vantage API key..."
          echo "ðŸ”‘ API Key (first 8 chars): ${ALPHA_VANTAGE_KEY:0:8}..."
          
          # Try to run the real ETL
          if python3 -m etl.main; then
            echo "âœ… ETL completed successfully with live data"
          else
            echo "âŒ ETL failed, falling back to sample data..."
            python3 generate_sample_data.py
          fi
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add data files
        git add data/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "ðŸ“ˆ No changes to screening data"
        else
          # Get current date for commit message
          CURRENT_DATE=$(date +'%Y-%m-%d')
          
          # Create commit with screening update
          git commit -m "ðŸ“Š Update Magic Formula screening data - $CURRENT_DATE

          ðŸ”„ Automated weekly screening update
          ðŸ“… Run date: $CURRENT_DATE
          ðŸ¤– Generated by GitHub Actions
          
          ðŸŽ¯ Updated screening includes:
          - Latest earnings yield calculations
          - Return on capital metrics  
          - Magic Formula rankings
          - Market cap and financial data"
          
          # Push changes
          git push
          
          echo "âœ… Successfully updated screening data"
        fi
        
    - name: Create summary
      run: |
        echo "## ðŸ“Š Magic Formula Screening Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "data/metadata.json" ]; then
          echo "### ðŸ“ˆ Latest Data" >> $GITHUB_STEP_SUMMARY
          python3 -c "import json; meta=json.load(open('data/metadata.json')); print(f'- **Run Date**: {meta.get(\"run_date\", \"Unknown\")[:19]}'); print(f'- **Total Stocks**: {meta.get(\"total_stocks\", \"Unknown\")}'); print(f'- **Data Sources**: {meta.get(\"data_sources\", [\"Unknown\"])}')" >> $GITHUB_STEP_SUMMARY
        
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ† Top 3 Picks" >> $GITHUB_STEP_SUMMARY
          python3 -c "import pandas as pd; df=pd.read_csv('data/latest_screening.csv'); [print(f'{int(row[\"magic_formula_rank\"])}. **{row[\"ticker\"]}** - {row[\"company_name\"]}\\n   - Earnings Yield: {row[\"earnings_yield\"]*100:.2f}%\\n   - ROC: {row[\"roc\"]*100:.2f}%\\n') for _, row in df.head(3).iterrows()]" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No screening data available" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **View the live dashboard**: [Streamlit App](https://your-app.streamlit.app)" >> $GITHUB_STEP_SUMMARY