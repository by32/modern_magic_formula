name: Update Magic Formula Screening

on:
  schedule:
    # Run every Monday at 6:00 UTC (after markets close)
    - cron: '0 6 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  update-screening:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install UV Package Manager
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Install Dependencies
      run: |
        uv sync --reinstall  # Clean install to avoid binary incompatibility
        
    - name: Run ETL process
      env:
        ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
        FMP_KEY: ${{ secrets.FMP_KEY }}
        FINNHUB_KEY: ${{ secrets.FINNHUB_KEY }}
        IEX_TOKEN: ${{ secrets.IEX_TOKEN }}
      timeout-minutes: 45
      run: |
        echo "ðŸ”‘ Running Russell 1000 ETL with hybrid SEC+Yahoo approach..."

        # Run the Russell 1000 ETL - no fallback to sample data
        if uv run python -m etl.main_russell_hybrid; then
          echo "âœ… Russell 1000 ETL completed successfully"
        else
          echo "âŒ Russell 1000 ETL failed"
          exit 1
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add data files
        git add data/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "ðŸ“ˆ No changes to screening data"
        else
          # Get current date for commit message
          CURRENT_DATE=$(date +'%Y-%m-%d')
          
          # Create commit with screening update
          git commit -m "ðŸ“Š Update Russell 1000 Magic Formula screening - $CURRENT_DATE

          ðŸ”„ Automated weekly Russell 1000 screening update
          ðŸ“… Run date: $CURRENT_DATE
          ðŸ¤– Generated by GitHub Actions
          
          ðŸŽ¯ Updated screening includes:
          - Full Russell 1000 universe (~1000 stocks)
          - Latest earnings yield calculations
          - Return on capital metrics  
          - Magic Formula rankings with sector analysis
          - Alpha Vantage + Yahoo Finance data sources"
          
          # Push changes
          git push
          
          echo "âœ… Successfully updated screening data"
        fi
        
    - name: Create summary
      run: |
        echo "## ðŸ“Š Russell 1000 Magic Formula Screening Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "data/metadata_hybrid.json" ]; then
          echo "### ðŸ“ˆ Latest Russell 1000 Data" >> $GITHUB_STEP_SUMMARY
          uv run python -c "import json; meta=json.load(open('data/metadata_hybrid.json')); print(f'- **Run Date**: {meta.get(\"run_date\", \"Unknown\")[:19]}'); print(f'- **Stocks Processed**: {meta.get(\"total_stocks\", \"Unknown\")}/{meta.get(\"russell_1000_stocks\", \"Unknown\")} Russell 1000 stocks'); print(f'- **Processing Time**: {meta.get(\"processing_time_seconds\", 0):.1f} seconds'); print(f'- **SEC EDGAR Coverage**: {meta.get(\"data_sources\", {}).get(\"sec_edgar_coverage\", \"Unknown\")}')" >> $GITHUB_STEP_SUMMARY
        
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ† Top 5 Magic Formula Picks" >> $GITHUB_STEP_SUMMARY
          uv run python -c "import pandas as pd; df=pd.read_csv('data/latest_screening_hybrid.csv'); [print(f'{int(row[\"magic_formula_rank\"])}. **{row[\"ticker\"]}** - {row[\"company_name\"]}\\n   - EY: {row[\"earnings_yield\"]*100:.2f}% | ROC: {row[\"roc\"]*100:.2f}% | Sector: {row.get(\"sector\", \"Unknown\")}\\n') for _, row in df.head(5).iterrows()]" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No Russell 1000 screening data available" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **View the live dashboard**: [Vercel App](https://modernmagicformula.vercel.app)" >> $GITHUB_STEP_SUMMARY